---
title: 双向绑定的简单实现
date: 2017-08-09 20:13:39
tags:
- 双向绑定
categories: [JS]
---
<p></p>
<!-- more -->
## 用JS实现简单的双向绑定 ##
代码如下:
html代码
```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document</title>
</head>
<body>
  <div id="app">
    <input v-model="message" />
    <p v-model="message"></p>
    <input v-model="text" />
    <p v-model="text"></p>
  </div>
  <script type="text/javascript" src="vue1.0.0.js"></script>
  <script type="text/javascript">
    new Vue({ //MVVM
      el: "#app",
      data: {
        message: "huang",
        text: "jing"
      }
    })
  </script>
</body>
</html>
```

javascript代码
```javascript
(function(root, factory){
  root.Vue = factory()
})(this, function(){//this指向window对象,funciton为工厂函数
  //默认配置
  var DEFAULT = {
    el: "body",
    data: {}
  }
  var Vue = function(options){
    //extend
    this.extend(this, DEFAULT, options); 
    this.el = document.querySelector(this.el)//由字符串转换为真正的dom对象,要放在observer前面
    this.observer();
    var elements = this.el.querySelectorAll("[v-model]");//查找所有绑定v-model的属性
    var data = this.data;
    for(var i = 0;i < elements.length;i++){
      elements[i].onkeyup = function(){
        data[this.getAttribute("v-model")] = this.value
      }        
    }
  }

  Vue.prototype = {
    extend: function(){
      for(var i = 1;i < arguments.length;i++){
        for(var name in arguments[i]){
          this[name] = arguments[i][name]//以默认配置为优先，以用户配置为覆盖
        }
      }
    },
    observer:function(){ //this data
      var el = this.el;
      for(var key in this.data){//此处需要用到闭包
        var that = this;
        (function(key){
          Object.defineProperty(that.data, key, {
            get:function(){
              return that.value;
            },
            set:function(value){
              var models = el.querySelectorAll('[v-model="' + key + '"]');//找到所有绑定v-model的属性值元素对象
              for(var i = 0;i < models.length;i++){
                models[i].value = value;
                models[i].innerHTML = value;
              }
              that.value = value;
            }
          })
        })(key);
      }
    }
  }
  return Vue;
});
```

双向绑定的核心就在于Object.defineProperty可以检测到对象上的属性值变化